#! /bin/sh /usr/share/dpatch/dpatch-run
# Description: fix unanticipated internal calls to srand
# Origin: upstream, https://sourceforge.net/p/expat/code_git/ci/f627ff74d631f4548f924ca5bd27ddad6cae07ab/

@DPATCH@
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' expat-2.0.1~/lib/xmlparse.c expat-2.0.1/lib/xmlparse.c
--- expat-2.0.1~/lib/xmlparse.c	2016-06-10 08:54:02.000000000 -0400
+++ expat-2.0.1/lib/xmlparse.c	2016-06-10 08:54:07.832439514 -0400
@@ -704,9 +704,16 @@
 generate_hash_secret_salt(XML_Parser parser)
 {
   /* Process ID is 0 bits entropy if attacker has local access
-   * XML_Parser address is few bits of entropy if attacker has local access
-   * Factor is 2^61-1 (Mersenne prime M61) */
-  return (gather_time_entropy() ^ getpid() ^ (unsigned long)parser) * 2305843009213693951;
+   * XML_Parser address is few bits of entropy if attacker has local access */
+  const unsigned long entropy =
+      gather_time_entropy() ^ getpid() ^ (unsigned long)parser;
+
+  /* Factors are 2^31-1 and 2^61-1 (Mersenne primes M31 and M61) */
+  if (sizeof(unsigned long) == 4) {
+    return entropy * 2147483647;
+  } else {
+    return entropy * 2305843009213693951;
+  }
 }
 
 static XML_Bool  /* only valid for root parser */
