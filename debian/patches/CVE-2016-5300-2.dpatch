#! /bin/sh /usr/share/dpatch/dpatch-run
# Description: fix use of too little entropy
# Origin: upstream, https://sourceforge.net/p/expat/code_git/ci/ca523deca47303436fe522d030dbd9af3635be60/

@DPATCH@
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' expat-2.0.1~/lib/xmlparse.c expat-2.0.1/lib/xmlparse.c
--- expat-2.0.1~/lib/xmlparse.c	2016-06-10 08:52:57.000000000 -0400
+++ expat-2.0.1/lib/xmlparse.c	2016-06-10 08:53:49.996258150 -0400
@@ -434,7 +434,7 @@
 getElementType(XML_Parser parser, const ENCODING *enc,
                const char *ptr, const char *end);
 
-static unsigned long generate_hash_secret_salt(void);
+static unsigned long generate_hash_secret_salt(XML_Parser parser);
 static XML_Bool startParsing(XML_Parser parser);
 
 static XML_Parser
@@ -701,11 +701,12 @@
 }
 
 static unsigned long
-generate_hash_secret_salt(void)
+generate_hash_secret_salt(XML_Parser parser)
 {
   /* Process ID is 0 bits entropy if attacker has local access
+   * XML_Parser address is few bits of entropy if attacker has local access
    * Factor is 2^61-1 (Mersenne prime M61) */
-  return (gather_time_entropy() ^ getpid()) * 2305843009213693951;
+  return (gather_time_entropy() ^ getpid() ^ (unsigned long)parser) * 2305843009213693951;
 }
 
 static XML_Bool  /* only valid for root parser */
@@ -714,7 +715,7 @@
   /* hash functions must be initialized before setContext() is called */
 
   if (hash_secret_salt == 0)
-    hash_secret_salt = generate_hash_secret_salt();
+    hash_secret_salt = generate_hash_secret_salt(parser);
   if (ns) {
     /* implicit context only set for root parser, since child
        parsers (i.e. external entity parsers) will inherit it
