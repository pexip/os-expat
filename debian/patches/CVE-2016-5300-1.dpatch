#! /bin/sh /usr/share/dpatch/dpatch-run
# Description: fix use of too little entropy
# Origin: upstream, https://sourceforge.net/p/expat/code_git/ci/a5f2d0406056d384cdd4b9955384703137a4d19a/

@DPATCH@
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' expat-2.0.1~/lib/xmlparse.c expat-2.0.1/lib/xmlparse.c
--- expat-2.0.1~/lib/xmlparse.c	2016-06-10 08:52:43.000000000 -0400
+++ expat-2.0.1/lib/xmlparse.c	2016-06-10 08:52:48.915639728 -0400
@@ -688,7 +688,7 @@
 };
 
 static unsigned long
-generate_hash_secret_salt(void)
+gather_time_entropy(void)
 {
   struct timeval tv;
   int gettimeofday_res;
@@ -696,10 +696,16 @@
   gettimeofday_res = gettimeofday(&tv, NULL);
   assert (gettimeofday_res == 0);
 
-  /* Microseconds time is <20 bits entropy
-   * Process ID is 0 bits entropy if attacker has local access
+  /* Microseconds time is <20 bits entropy */
+  return tv.tv_usec;
+}
+
+static unsigned long
+generate_hash_secret_salt(void)
+{
+  /* Process ID is 0 bits entropy if attacker has local access
    * Factor is 2^61-1 (Mersenne prime M61) */
-  return (tv.tv_usec ^ getpid()) * 2305843009213693951;
+  return (gather_time_entropy() ^ getpid()) * 2305843009213693951;
 }
 
 static XML_Bool  /* only valid for root parser */
